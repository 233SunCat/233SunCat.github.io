---
title: Redis数据库
date: 2021-03-12 22:58:40
categories: 
- 数据库
---
Redis是单线程
6.x支持多线程IO但是还是单线程读
且每种数据类型给都有自己的方法
redis比memcache并发要快很多原因：比如一个数组[a,b,c,d]客客户端需要第二个索引数据
redis单线程是：串行化
链接池：list放入socket
线程池：
链接池与线程池可不一样
在linux中安装redis数据库
要多用linux，不然真的陌生

redis与epoll多路复用器的设计与串行化与单线程

redis中string的底层数据结构
SDS,简单动态字符串
针对不同长度的字符串各有结构体
这些结构体中有定义长度
所以获取字符串长度的时间复杂度O（1）

列表list,底层数据结构双向链表
可以LPUSH,RPUSH,LPOP,RPOP

hash底层使用hash,解决冲突：链地址法(数组+链表)
特点：渐进式rehash，rehash：将一个hash搬迁到另一个新的hash，渐进式rehash，是为了防止搬迁数据量过大导致服务器卡顿，每次对hash操作的时候渐进式搬迁

集合底层数据结构：比一般的集合改进一点，比如柔性数组，整数类型会升级

有序集合：经典跳跃表很好理解，有序集合在这上面加上了一点改进，比如跳跃表第一层用了双向链表，方便倒序范围查找

有序集合和hash都还有一个压缩字典的数据结构



我的redis使用时存储热点文章(点赞数量)，定点维护更新(每次数据库发生修改更新插入等操作则刷新缓存)

1.监听数据库变化，2.刷新redis的机制(另起一个协程刷新)
思路：具体就是每次提交事务go中都会返回一个成功的信息，然后数据库排序之后取前十个文章，直接刷新redis缓存
这个刷新机制具体：后端会把mysql中点赞前十的文章名插入redis数据库
redis数据库的数据结构：有序集合：文章名字+点赞数量

redis的添加：ZADD wenzhang 20 "文章名字"
获取redis现在有多少的元素：ZCARD wenzhang

不需要做什么发布订阅功能，因为redis是随着数据库刷新的

我现在在做的是：更加灵活的运用redis数据库
热点数据的功能：前百分之十的文章(点赞数量来排名)
直接使用hash类型：数据格式：文章名+文章内容+文章点赞数量+文章点赞数量+文章ID
添加文章到缓存HMSET name " "  txt "' '" num "" 
问题是怎么维护：最简单粗暴的方式：每次更新数据库，选前百分之十的文章加载到缓存

每次修改数据库的时候返回文章点赞数前百分之十的文章ID
然后与redis中的ID对比，如果有不同则再走次数据库，然后加载到内存

如果缓存越来越大怎么办：那就把缓存大小作为数据加入计算公式，来计算缓存中应该放入多少篇文章

这三个整个项目的核心重点1.redis的排名，2.redis的热点数据，3.协程池
我现在最担心的就是这个三个不能精通

协程池的核心代码：任务：task{文章名字+文章内容+文章点赞数量+图片)

type Pool1 struct { freeworkerNum int //空闲协程数量
worknum int//工作协程数量//最多并发100个协程
 }
type Pool1 struct { freeworkerNum int //空闲协程数量
worknum int//工作协程数量//最多并发100个协程
 }
//读的请求体:文章名字+文章类型

开两个协程池：1个往通道写请求，1个往通道发送请求mysql，并发程度相对提升


写的话开一个协程就够了